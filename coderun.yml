steps:
  compile:
    image: golang:1.8.5
    commands:
      - go build -o dist/startup

  docker:
    image: crun/docker
    registry_name: coderun
    repo_name: hellwen/startup
    dockerfile_content: |
        FROM alpine:3.4
        ADD dist/startup /bin/
        ENTRYPOINT ["/bin/startup"]
    context: .
    tags: latest

  deploy-inline:
    image: crun/kube
    cluster_name: myk8s
    namespace: default
    template_content: |
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: startup
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: startup
          template:
            metadata:
              labels:
                app: startup
            spec:
              containers:
              - name: startup
                image: r.crun.top/hellwen/startup

  deploy-file:
    image: crun/kube
    cluster_name: myk8s
    namespace: default
    template: deployment.yml

  deploy-config:
    image: crun/kube
    cluster_name: myk8s
    deploy_name: startup
    namespace: default

  push-chart:
    image: crun/helm
    cluster_name: myk8s
    helm_name: coderun
    action: push
    chart_name: mychart

  install-chart:
    image: crun/helm
    cluster_name: myk8s
    namespace: default
    helm_name: coderun
    action: install
    release_name: mychart
    chart_name: coderun/mychart

branches: master
